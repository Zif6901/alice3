<script>
    const dfMessenger = document.querySelector('df-messenger');
    const micBtn = document.getElementById('voice-trigger-btn');
    let isRecording = false;

    // --- SETUP SPEECH RECOGNITION ---
    // Check for browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
      console.error("This browser does not support Web Speech API");
      micBtn.style.display = "none"; // Hide button if not supported
    }

    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    // --- MIC HANDLERS ---
    function toggleRecording() {
      if (isRecording) {
        recognition.stop();
      } else {
        // Ensure the chat is open so the user can see their message
        dfMessenger.setAttribute('expand', 'true');
        recognition.start();
      }
    }

    // When recording actually starts
    recognition.onstart = () => {
      isRecording = true;
      micBtn.classList.add('recording'); // Add pulse animation
      console.log('Voice recognition activated. Speak now.');
    };

    // When recording stops (either manually or silence detected)
    recognition.onend = () => {
      isRecording = false;
      micBtn.classList.remove('recording'); // Remove pulse animation
      console.log('Voice recognition stopped.');
    };

    // --- THE MISSING PART: HANDLE RESULTS ---
    recognition.onresult = (event) => {
      // 1. Get the transcript of what was said
      const transcript = event.results[0][0].transcript;
      console.log("User said: ", transcript);

      // 2. Send the text to Dialogflow Messenger
      // 'true' indicates this is a user query that requires a bot response
      if (transcript) {
        dfMessenger.renderCustomText(transcript, true);
      }
    };

    // Handle errors (e.g., microphone permission denied)
    recognition.onerror = (event) => {
      console.error("Speech recognition error", event.error);
      isRecording = false;
      micBtn.classList.remove('recording');
    };
  </script>

 
  

